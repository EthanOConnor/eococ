<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>COC Newsletter Project Dashboard</title>
  <style>
    :root{ --bg:#0b0f14;--panel:#0f1621;--panel-2:#101826;--text:#e6edf3;--muted:#8aa1b4;--accent:#5eb1ff;--ok:#1fbf75;--warn:#ffcc66;--err:#ff6b6b;--chip:#1a2433; --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; --sans:system-ui,-apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:var(--sans)}
    .wrap{display:grid;grid-template-rows:auto auto 1fr;gap:10px;padding:14px}
    .toolbar{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center}
    .toolbar input, .toolbar select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:var(--panel);color:var(--text)}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#152031;color:var(--text);cursor:pointer}
    .btn.secondary{background:transparent}
    .banner{display:none;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,107,107,.35);background:rgba(255,107,107,.12);color:#ffd8d8;margin-bottom:8px;font-size:13px;line-height:1.4}
    .issue-link{color:inherit;text-decoration:none}
    .issue-link:hover{text-decoration:underline;color:var(--accent)}
    .panels{display:grid;grid-template-columns: 2.2fr 1fr;gap:12px;min-height:60vh}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03)}
    .content{padding:12px}
    .grid{width:100%;border-collapse:collapse}
    .grid th,.grid td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left;font-size:14px}
    .grid th{color:var(--muted);font-weight:600}
    .grid tr:hover{background:rgba(255,255,255,.03)}
    .progress{height:10px;background:#0c131d;border-radius:6px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--ok),#49a7ff)}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:var(--chip);border:1px solid rgba(255,255,255,.1);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;background:var(--warn)}
    .status-dot.ok{background:var(--ok)}
    .status-dot.err{background:var(--err)}
    .filters{display:flex;flex-wrap:wrap;gap:8px}
    .filters .group{display:flex;gap:6px;align-items:center;background:var(--panel-2);border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:12px}
    .small{font-size:12px;color:var(--muted)}
    .sticky{position:sticky;top:0;background:var(--panel);z-index:1}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi{background:var(--panel-2);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
    .kpi .num{font-size:24px;font-weight:700}
    .kbd{font-family:var(--mono);font-size:12px;background:#0c131d;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:2px 6px}
    .foot{color:var(--muted);font-size:12px;margin-top:8px}
    @media (max-width:1100px){ .panels{grid-template-columns:1fr} .kpis{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <input id="search" type="search" placeholder="Search title, volume, year, month… (⌘/Ctrl+K)" />
    <select id="filterDecade"><option value="">All decades</option></select>
    <select id="filterMonth"><option value="">All months</option></select>
    <button id="btnSuggest" class="btn">Suggest Campaigns</button>
  </div>

  <div id="sampleBanner" class="banner"></div>

  <div class="kpis" id="kpis"></div>

  <div class="panels">
    <div class="card">
      <h3 class="sticky">Issues <span class="small" id="count"></span></h3>
      <div class="content" style="padding:0">
        <table class="grid" id="table">
          <thead>
            <tr>
              <th>Issue</th>
              <th>Declared Dates</th>
              <th>Vol/No</th>
              <th>Status</th>
              <th>Progress</th>
              <th>Files</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Project Overview</h3>
      <div class="content">
        <canvas id="chart1" height="220"></canvas>
        <div class="foot">Charts summarize the filtered set. Use decade/month filters to focus efforts.</div>
        <hr style="border-color:rgba(255,255,255,.06)"/>
        <div id="suggestions"></div>
      </div>
    </div>
  </div>

  <div class="foot">Data source: <span id="dataSrc" class="kbd"></span>. Configure with <span class="kbd">?data=/data/newsletters.json</span>.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
const DATA_PARAM = new URLSearchParams(location.search).get('data');
const PATH_MATCH = location.pathname.match(/^(.*)\/dashboard\/index\.html$/);
const SITE_BASE = PATH_MATCH ? PATH_MATCH[1] : '';
const BASE_URL = `${location.origin}${SITE_BASE ? SITE_BASE + '/' : '/'}`;

const isAbsoluteUrl = (p)=> /^(?:[a-z]+:)?\/\//i.test(p);
const toAbsolute = (p)=>{
  if (!p) return null;
  if (isAbsoluteUrl(p)) return p;
  const cleaned = p.replace(/^\/+/, '');
  return new URL(cleaned, BASE_URL).href;
};
const displayPath = (p)=>{
  if (!p) return '';
  if (isAbsoluteUrl(p)) return p;
  const cleaned = p.replace(/^\/+/, '');
  const prefix = SITE_BASE ? SITE_BASE + '/' : '';
  return `${prefix}${cleaned}`;
};

const DEFAULT_DATA_URL = toAbsolute(DATA_PARAM || 'data/newsletters.json');
const DATA_LABEL = displayPath(DATA_PARAM || 'data/newsletters.json');
let usingSampleData = false;
// Stage weights now include scan_fullsize
const STAGE_WEIGHTS = {
  physical_on_hand: 5,
  scan_initial: 10,
  scan_fullsize: 10,
  scan_archival: 15,
  transcript_auto: 10,
  transcript_review1: 20,
  transcript_review2: 20,
  annotation_people: 10,
  annotation_places: 5,
  annotation_events: 5,
};

const $ = (s)=>document.querySelector(s);
const fmtPct = (n)=> (Math.round(n)).toString()+"%";
const monthName = (m)=> new Date(2000, (m||1)-1, 1).toLocaleString(undefined,{month:'short'});
const escape = (s)=> (s||'').toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));

function progressFromStatus(st){
  if (!st) return 0;
  let total = 0;
  for (const [k,w] of Object.entries(STAGE_WEIGHTS)){
    const v = st[k];
    const state = (typeof v === 'object' && v)? v.state : (v? 'done':'todo');
    const frac = state==='done'?1: state==='in_progress'?0.5: 0;
    total += w*frac;
  }
  return total;
}
function statusChip(state){
  const cls = state==='done'?'ok': state==='in_progress'?'' : 'err';
  const label = state==='done'? 'done' : state==='in_progress'? 'in progress' : 'todo';
  return `<span class="chip"><i class="status-dot ${cls}"></i>${label}</span>`
}

async function loadData(){
  $('#dataSrc').textContent = DATA_LABEL;
  try{
    const res = await fetch(DEFAULT_DATA_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const json = await res.json();
    usingSampleData = false;
    updateSampleBanner();
    return Array.isArray(json)? json : json.issues;
  }catch(e){
    console.warn('Using sample data because load failed:', e);
    usingSampleData = true;
    updateSampleBanner(e);
    return SAMPLE;
  }
}

function updateSampleBanner(error){
  const banner = $('#sampleBanner');
  if (!banner) return;
  if (usingSampleData){
    const reason = error?.message ? ` (reason: ${error.message})` : '';
    banner.innerHTML = `⚠️ Using sample data. Could not load <span class="kbd">${DATA_LABEL}</span>${reason}. Serve this page via HTTP or GitHub Pages and, if needed, call this page with <span class="kbd">?data=data/newsletters.json</span> to use project data.`;
    banner.style.display = 'block';
  } else {
    banner.style.display = 'none';
    banner.textContent = '';
  }
}

function buildProofLink(issue){
  if (!issue) return null;
  const md = issue.files?.md ? toAbsolute(issue.files.md) : null;
  const pdfPath = issue.files?.pdf_fullsize || issue.files?.pdf_archival || issue.files?.pdf || issue.files?.pdf_initial;
  const pdf = pdfPath ? toAbsolute(pdfPath) : null;
  if (!md && !pdf) return null;
  const proofUrl = new URL('proof/index.html', BASE_URL);
  if (md) proofUrl.searchParams.set('md', md);
  if (pdf) proofUrl.searchParams.set('pdf', pdf);
  if (!proofUrl.searchParams.has('view')) proofUrl.searchParams.set('view','rendered');
  return proofUrl.href;
}

let ISSUES = [];
let filtered = [];
let chart;

function buildFilters(){
  const decades = [...new Set(ISSUES.map(x=> Math.floor((x.year||new Date(x.declared_date_start||x.declared_date_end).getFullYear())/10)*10 ))].filter(Boolean).sort((a,b)=>a-b);
  $('#filterDecade').innerHTML = '<option value="">All decades</option>' + decades.map(d=>`<option value="${d}">${d}s</option>`).join('');
  $('#filterMonth').innerHTML = '<option value="">All months</option>' + Array.from({length:12},(_,i)=>`<option value="${i+1}">${monthName(i+1)}</option>`).join('');
}
function applyFilters(){
  const q = $('#search').value.trim().toLowerCase();
  const decade = $('#filterDecade').value;
  const month = $('#filterMonth').value;
  filtered = ISSUES.filter(x=>{
    const inSearch = !q || (`${x.name} ${x.volume||''} ${x.issue_number||''} ${x.year||''} ${x.month||''}`.toLowerCase().includes(q));
    const d = Math.floor((x.year||new Date(x.declared_date_start||x.declared_date_end).getFullYear())/10)*10;
    const inDec = !decade || d == parseInt(decade,10);
    const inMonth = !month || (x.month && x.month == parseInt(month,10));
    return inSearch && inDec && inMonth;
  });
  $('#count').textContent = `${filtered.length} result${filtered.length===1?'':'s'}`;
  renderTable(); renderKPIs(); renderChart(); suggestCampaigns();
}
function renderTable(){
  const tb = $('#tbody');
  tb.innerHTML = filtered.map(x=>{
    const start = x.declared_date_start? new Date(x.declared_date_start): null;
    const end = x.declared_date_end? new Date(x.declared_date_end): null;
    const dateTxt = start && end ? `${start.toLocaleDateString()} – ${end.toLocaleDateString()}` : (start? start.toLocaleDateString(): (x.year? `${monthName(x.month||1)} ${x.year}`:''));
    const st = x.status||{}; const p = progressFromStatus(st);
    const vols = `${x.volume??''}${x.issue_number? ('/'+x.issue_number): ''}`;
    const files = [`pdf`,`pdf_fullsize`,`pdf_archival`,`md`].map(k=> {
      const href = x.files?.[k] ? toAbsolute(x.files[k]) : null;
      return href ? `<a class="chip" href="${href}" target="_blank" rel="noopener">${k.toUpperCase().replace('_',' ')}</a>` : '';
    }).join(' ');
    const critical = ['scan_archival','transcript_review2'];
    const stateCrit = critical.map(k=> {const v=st[k]; const s=(typeof v==='object'&&v)?v.state:(v? 'done':'todo'); return s;});
    const rowWarn = stateCrit.includes('todo');
    const proofLink = buildProofLink(x);
    const title = escape(x.name||`Issue ${x.id}`);
    const issueTitleHtml = proofLink ? `<a class="issue-link" href="${proofLink}" target="_blank" rel="noopener">${title}</a>` : title;
    return `<tr${rowWarn? ' style="background:rgba(255,107,107,0.05)"':''}>
      <td><div style="font-weight:600">${issueTitleHtml}</div><div class="small">${x.id||''}</div></td>
      <td>${dateTxt||''}</td>
      <td>${escape(vols)}</td>
      <td class="chips">
        <span class="chip">Physical ${statusChip((st.physical_on_hand&& (typeof st.physical_on_hand==='object'? st.physical_on_hand.state: (st.physical_on_hand? 'done':'todo')))||'todo')}</span>
        <span class="chip">Initial ${statusChip(st.scan_initial?.state || (st.scan_initial? 'done':'todo'))}</span>
        <span class="chip">Fullsize ${statusChip(st.scan_fullsize?.state || (st.scan_fullsize? 'done':'todo'))}</span>
        <span class="chip">Archival ${statusChip(st.scan_archival?.state || (st.scan_archival? 'done':'todo'))}</span>
        <span class="chip">Auto-Tx ${statusChip(st.transcript_auto?.state || (st.transcript_auto? 'done':'todo'))}</span>
        <span class="chip">Review1 ${statusChip(st.transcript_review1?.state || (st.transcript_review1? 'done':'todo'))}</span>
        <span class="chip">Review2 ${statusChip(st.transcript_review2?.state || (st.transcript_review2? 'done':'todo'))}</span>
        <span class="chip">NER:People ${statusChip(st.annotation_people?.state || (st.annotation_people? 'done':'todo'))}</span>
      </td>
      <td style="min-width:160px"><div class="progress" title="${fmtPct(p)}"><i style="width:${Math.max(2,p)}%"></i></div><div class="small">${fmtPct(p)}</div></td>
      <td>${files}</td>
    </tr>`
  }).join('');
}
function renderKPIs(){
  const total = filtered.length; const sumP = filtered.reduce((a,x)=>a+progressFromStatus(x.status||{}),0); const avg = total? sumP/total : 0;
  function countDone(key){ return filtered.reduce((a,x)=>{ const v=x.status?.[key]; const s=(typeof v==='object'&&v)? v.state : (v? 'done':'todo'); return a + (s==='done'); },0); }
  $('#kpis').innerHTML = `
    <div class="kpi"><div class="small">Issues (filtered)</div><div class="num">${total}</div></div>
    <div class="kpi"><div class="small">Avg Progress</div><div class="num">${fmtPct(avg)}</div></div>
    <div class="kpi"><div class="small">Fully Reviewed (R2)</div><div class="num">${countDone('transcript_review2')}</div></div>
    <div class="kpi"><div class="small">Archival Scans</div><div class="num">${countDone('scan_archival')}</div></div>`;
}
function renderChart(){
  const ctx = document.querySelector('#chart1');
  const byStage = Object.keys(STAGE_WEIGHTS).map(k=>({ stage:k, done: filtered.reduce((a,x)=>{ const v=x.status?.[k]; const s=(typeof v==='object'&&v)?v.state:(v? 'done':'todo'); return a+(s==='done'); },0) }));
  const labels = byStage.map(x=>x.stage.replace(/_/g,' '));
  const data = byStage.map(x=>x.done);
  if (window.chart){ window.chart.destroy(); }
  window.chart = new Chart(ctx, {type:'bar', data:{labels, datasets:[{label:'Done (count)', data}]}, options:{plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#9fb1c4'}},y:{ticks:{color:'#9fb1c4'}}}}});
}
function suggestCampaigns(){
  const el = document.querySelector('#suggestions');
  if (!filtered.length){ el.innerHTML = '<div class="small">No data to suggest from.</div>'; return; }
  const needsR2 = filtered.filter(x=>{ const v=x.status?.transcript_review2; const s=(typeof v==='object'&&v)?v.state:(v? 'done':'todo'); return s!=='done'; });
  const needsArchival = filtered.filter(x=>{ const v=x.status?.scan_archival; const s=(typeof v==='object'&&v)?v.state:(v? 'done':'todo'); return s!=='done'; });
  const nov80s = filtered.filter(x=> (x.month===11) && (Math.floor((x.year||0)/10)===1980));
  function block(title, arr){ return `<div class="card" style="margin-bottom:10px"><h3>${title}</h3><div class="content"><div class="small">${arr.length} issue(s)</div><div class="chips" style="margin-top:8px">${arr.slice(0,12).map(x=>`<span class=\"chip\">${escape(x.id||x.name)}</span>`).join('')}${arr.length>12? '…':''}</div></div></div>`; }
  el.innerHTML = block('🏁 Finish Review 2 for the filtered set', needsR2)
              + block('📚 Produce Archival Scans for the filtered set', needsArchival)
              + block('🍂 Annotate November issues in the 1980s', nov80s);
}

document.querySelector('#search').addEventListener('input', applyFilters);
document.querySelector('#filterDecade').addEventListener('change', applyFilters);
document.querySelector('#filterMonth').addEventListener('change', applyFilters);
document.querySelector('#btnSuggest').addEventListener('click', ()=>{
  const s = document.querySelector('#suggestions'); s.style.display = (s.style.display==='none')? 'block':'none';
});
window.addEventListener('keydown', (e)=>{ if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); document.querySelector('#search').focus(); } });

let SAMPLE = [
  { id:"1987-11", name:"Cascade Orienteer — November 1987", year:1987, month:11, declared_date_start:"1987-11-01", declared_date_end:"1987-11-30", volume:12, issue_number:9, files:{ pdf:"/newsletters/1987/11_initial.pdf", pdf_fullsize:"/newsletters/1987/11_full.pdf", pdf_archival:"/newsletters/1987/11_arch.pdf", md:"/newsletters/transcripts/1987/1987-11.md" }, status:{ physical_on_hand:true, scan_initial:true, scan_fullsize:true, scan_archival:false, transcript_auto:true, transcript_review1:{state:'done'}, transcript_review2:{state:'in_progress'}, annotation_people:false } },
  { id:"1991-03", name:"Cascade Orienteer — March 1991", year:1991, month:3, declared_date_start:"1991-03-01", declared_date_end:"1991-03-31", volume:16, issue_number:3, files:{ pdf:"/newsletters/1991/03_initial.pdf", md:"/newsletters/transcripts/1991/1991-03.md" }, status:{ physical_on_hand:true, scan_initial:true, scan_archival:true, transcript_auto:true, transcript_review1:true, transcript_review2:true, annotation_people:{state:'in_progress'} } },
];
(async function(){ ISSUES = await loadData(); buildFilters(); applyFilters(); })();
</script>
</body>
</html>
